<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Compound Growth Calculator</title>

<!-- iOS full-screen & title -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Growth Calc">

<!-- Icon files you’ll upload (optional but recommended) -->
<link rel="apple-touch-icon" href="./icon-180.png">
<link rel="icon" href="./icon-192.png">
<meta name="theme-color" content="#0e111a">

<!-- PWA Manifest -->
<link rel="manifest" href="./manifest.webmanifest">

<!-- Prevent iOS from turning numbers into tel: links -->
<meta name="format-detection" content="telephone=no" />

<style>
  :root{
    --bg:#0e111a; --panel:#141827; --ink:#eef1f5; --muted:#9aa3b2;
    --accent:#7dd3fc; --accent2:#34d399; --line:#23283b; --danger:#ef4444; --rad:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 900px at 80% -10%, #1b2141 0, #0e111a 60%);color:var(--ink)}
  .wrap{max-width:1060px;margin:0 auto;padding:20px 16px 40px;
        padding-top:calc(20px + env(safe-area-inset-top));
        padding-bottom:calc(36px + env(safe-area-inset-bottom));}
  h1{margin:6px 0 14px;font-size:22px;letter-spacing:.2px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:980px){.grid{grid-template-columns:420px 1fr}}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:var(--rad);padding:14px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input,select{width:100%;padding:14px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:#0b0f1c;color:var(--ink);font-size:17px;outline:none;min-height:48px}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(125,211,252,.25)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{appearance:none;border:none;padding:13px 16px;border-radius:14px;font-weight:700;cursor:pointer;min-height:48px;font-size:17px}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#071218}
  .secondary{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.18)}
  .danger{background:var(--danger);color:#130a0a}
  .kpis{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:12px}
  @media (min-width:620px){.kpis{grid-template-columns:1fr 1fr 1fr}}
  .kpi{background:#0b0f1c;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;position:relative}
  .kpi .t{color:var(--muted);font-size:12px;margin-bottom:4px}
  .kpi .v{font-size:22px;font-weight:800;line-height:1.2}
  .kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}
  .pill{position:absolute;right:12px;top:12px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:#11152a}
  .controls-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .controls-inline input[type="range"]{width:160px}
  .table-wrap{max-height:320px;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.08)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;text-align:right;border-bottom:1px solid var(--line);font-variant-numeric:tabular-nums}
  th{position:sticky;top:0;background:rgba(10,12,24,.92);backdrop-filter:blur(8px);color:var(--muted)}
  td:first-child,th:first-child{text-align:left}
  .note{color:var(--muted);font-size:12px;margin-top:8px}
  .spark{width:100%;height:66px;display:block}
  .spark-wrap{background:#0b0f1c;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .footer-hint{margin-top:10px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Compound Growth Calculator</h1>

  <div class="grid">
    <!-- Inputs -->
    <div class="card">
      <div class="row">
        <div>
          <label for="initial">Initial contribution</label>
          <input id="initial" type="number" inputmode="decimal" min="0" step="0.01" value="10000" />
        </div>
        <div>
          <label for="monthly">Monthly contribution</label>
          <input id="monthly" type="number" inputmode="decimal" min="0" step="0.01" value="1000" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="rate">Annual growth rate (%)</label>
          <input id="rate" type="number" inputmode="decimal" step="0.01" value="8" />
        </div>
        <div>
          <label for="years">Years</label>
          <input id="years" type="number" inputmode="numeric" min="1" step="1" value="30" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="freq">Compounding frequency</label>
          <select id="freq">
            <option value="12" selected>Monthly (12)</option>
            <option value="4">Quarterly (4)</option>
            <option value="1">Annually (1)</option>
            <option value="26">Biweekly (26)</option>
            <option value="365">Daily (365)</option>
          </select>
        </div>
        <div>
          <label for="contribTiming">Contribution timing</label>
          <select id="contribTiming">
            <option value="end" selected>End of period (ordinary)</option>
            <option value="begin">Beginning of period (annuity due)</option>
          </select>
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="calc">Calculate</button>
        <button class="secondary" id="csv">Export monthly CSV</button>
        <button class="secondary" id="share">Copy share link</button>
        <button class="secondary" id="reset">Reset</button>
      </div>
      <div class="note">Auto-calculates as you type. Monthly input is converted to the chosen compounding frequency.</div>
    </div>

    <!-- Summary -->
    <div class="card">
      <div class="kpis" aria-live="polite">
        <div class="kpi">
          <span class="pill">Final</span>
          <div class="t">Final value</div>
          <div class="v" id="final">$0</div>
          <div class="sub" id="finalDesc"></div>
        </div>
        <div class="kpi">
          <span class="pill">Contrib</span>
          <div class="t">Total contributions</div>
          <div class="v" id="totalContrib">$0</div>
          <div class="sub" id="growthPortion"></div>
        </div>
        <div class="kpi">
          <span class="pill">Payout</span>
          <div class="t">Payout from final</div>
          <div class="v" id="payoutAnnual">$0</div>
          <div class="sub" id="payoutBreakdown">Monthly: $0 · Quarterly: $0</div>
          <div class="controls-inline">
            <label for="payoutPct" style="margin:0;color:var(--muted);font-size:12px">Percent</label>
            <input id="payoutPct" type="range" min="0" max="10" step="0.1" value="4" />
            <input id="payoutPctNum" type="number" min="0" max="100" step="0.1" value="4" style="width:90px" />
            <span class="sub" id="payoutNote"></span>
          </div>
        </div>
      </div>

      <div class="spark-wrap">
        <svg id="spark" class="spark" viewBox="0 0 600 66" preserveAspectRatio="none" aria-label="Balance over time sparkline"></svg>
      </div>

      <div class="toolbar">
        <button class="secondary" id="toggleTheme">Toggle theme</button>
        <span class="note">Tip: Add to Home Screen from the Share menu to use it like an app.</span>
      </div>

      <div class="table-wrap" style="margin-top:14px">
        <table id="yearly">
          <thead>
            <tr>
              <th>Year</th>
              <th>End Balance</th>
              <th>Total Contributed</th>
              <th>Growth This Year</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const fmtMoney = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
  const fmtPct = (x)=> (Number(x)||0).toFixed(1) + '%';

  function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); } }
  function valNum(el, fallback=0){ const n = Number(el.value); return Number.isFinite(n) ? n : fallback; }

  // URL state <-> inputs
  function stateFromInputs(){
    return {
      initial:$('initial').value, monthly:$('monthly').value, rate:$('rate').value, years:$('years').value,
      freq:$('freq').value, timing:$('contribTiming').value, payoutPct:$('payoutPctNum').value
    };
  }
  function applyState(s){
    if(!s) return;
    if(s.initial!=null) $('initial').value = s.initial;
    if(s.monthly!=null) $('monthly').value = s.monthly;
    if(s.rate!=null) $('rate').value = s.rate;
    if(s.years!=null) $('years').value = s.years;
    if(s.freq!=null) $('freq').value = s.freq;
    if(s.timing!=null) $('contribTiming').value = s.timing;
    if(s.payoutPct!=null){ $('payoutPct').value = s.payoutPct; $('payoutPctNum').value = s.payoutPct; }
  }
  function readQuery(){
    const u = new URL(location.href);
    const s = Object.fromEntries(u.searchParams.entries());
    return Object.keys(s).length ? s : null;
  }
  function copyShareLink(){
    const u = new URL(location.href);
    const s = stateFromInputs();
    Object.entries(s).forEach(([k,v])=> u.searchParams.set(k,v));
    navigator.clipboard.writeText(u.toString()).then(()=> alert('Share link copied!')).catch(()=>{});
  }

  function toggleTheme(){
    if(document.body.dataset.theme === 'light'){
      document.body.dataset.theme = '';
      document.documentElement.style.colorScheme = 'dark';
    }else{
      document.body.dataset.theme = 'light';
      document.documentElement.style.colorScheme = 'light';
    }
  }

  function calculate(){
    const P0 = Math.max(0, valNum($('initial'), 0));
    const monthly = Math.max(0, valNum($('monthly'), 0));
    const rAnnualPct = valNum($('rate'), 0);
    const years = Math.max(1, Math.floor(valNum($('years'), 1)));
    const freq = Math.max(1, Math.floor(valNum($('freq'), 12)));
    const timing = $('contribTiming').value;
    const payoutPct = Math.max(0, Number($('payoutPctNum').value)||0);

    const r = rAnnualPct / 100;
    const i = Math.pow(1 + r, 1 / freq) - 1;  // periodic eff. rate
    const C = monthly * (12 / freq);          // convert monthly to per-period
    const n = years * freq;

    let balance = P0;
    let totalContrib = P0;
    let periodsThisYear = 0;
    let growthThisYear = 0;

    const tbody = $('yearly').querySelector('tbody');
    tbody.innerHTML = '';
    const yearEnds = [];

    for(let p=1; p<=n; p++){
      if(timing === 'begin'){ balance += C; totalContrib += C; }
      const before = balance;
      balance *= (1 + i);
      const growth = balance - before;
      growthThisYear += growth;
      if(timing === 'end'){ balance += C; totalContrib += C; }

      if(++periodsThisYear === freq){
        const y = Math.ceil(p/freq);
        yearEnds.push(balance);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${y}</td>
          <td>${fmtMoney.format(balance)}</td>
          <td>${fmtMoney.format(totalContrib)}</td>
          <td>${fmtMoney.format(growthThisYear)}</td>
        `;
        tbody.appendChild(tr);
        periodsThisYear = 0; growthThisYear = 0;
      }
    }

    // KPIs
    $('final').textContent = fmtMoney.format(balance);
    $('finalDesc').textContent = `After ${years} year${years>1?'s':''} @ ${rAnnualPct.toFixed(2)}% with ${freq}× compounding.`;
    $('totalContrib').textContent = fmtMoney.format(totalContrib);
    $('growthPortion').textContent = `Growth portion: ${fmtMoney.format(balance - totalContrib)}`;

    // Payout box
    const payoutAnnual = balance * (payoutPct/100);
    $('payoutAnnual').textContent = fmtMoney.format(payoutAnnual);
    $('payoutBreakdown').innerHTML = `Monthly: ${fmtMoney.format(payoutAnnual/12)} · Quarterly: ${fmtMoney.format(payoutAnnual/4)}`;
    $('payoutNote').textContent = fmtPct(payoutPct);

    // Sparkline
    drawSpark(yearEnds);

    // Persist state in URL (no history push)
    const u = new URL(location.href);
    const s = stateFromInputs();
    Object.entries(s).forEach(([k,v])=> u.searchParams.set(k,v));
    history.replaceState(null,'',u.toString());
  }

  function drawSpark(values){
    const svg = $('spark'); svg.innerHTML = '';
    if(!values.length){ return; }
    const w = 600, h = 66, pad = 2;
    const min = Math.min(...values), max = Math.max(...values);
    const rng = (max - min) || 1;
    const points = values.map((v, idx)=>{
      const x = pad + (w - 2*pad) * (idx/(values.length-1 || 1));
      const y = h - pad - ((v - min)/rng) * (h - 2*pad);
      return [x,y];
    });
    const d = points.map((p,i)=> (i? 'L':'M') + p[0].toFixed(1) + ' ' + p[1].toFixed(1)).join(' ');
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', d);
    path.setAttribute('fill','none');
    path.setAttribute('stroke','url(#g)');
    path.setAttribute('stroke-width','2');
    const grad = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    grad.id='g'; grad.setAttribute('x1','0'); grad.setAttribute('y1','0'); grad.setAttribute('x2','1'); grad.setAttribute('y2','0');
    const s1 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#7dd3fc');
    const s2 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#34d399');
    grad.appendChild(s1); grad.appendChild(s2);
    svg.appendChild(grad); svg.appendChild(path);
  }

  function exportCSV(){
    const tbody = $('yearly').querySelector('tbody');
    if(!tbody.children.length){ alert('Please calculate first.'); return; }
    const rows = [['Year','End Balance','Total Contributed','Growth This Year']];
    Array.from(tbody.children).forEach(tr=>{
      rows.push(Array.from(tr.children).map(td => td.textContent.replace(/[$,]/g,'')));
    });
    const u = new URL(location.href);
    const meta = [
      ['Initial', $('initial').value],
      ['Monthly', $('monthly').value],
      ['AnnualRatePct', $('rate').value],
      ['Years', $('years').value],
      ['Frequency', $('freq').value],
      ['Timing', $('contribTiming').value],
      ['PayoutPct', $('payoutPctNum').value],
    ];
    const csv = [
      'Compound Growth Calculator (Yearly Export)',
      ...meta.map(([k,v])=>`${k},${v}`),
      '',
      rows[0].join(','),
      ...rows.slice(1).map(r=>r.join(',')),
      '',
      `ShareURL,${u.toString()}`
    ].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.href = url; a.download = `compound-yearly-${ts}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function reset(){
    $('initial').value = 10000;
    $('monthly').value = 1000;
    $('rate').value = 8;
    $('years').value = 30;
    $('freq').value = 12;
    $('contribTiming').value = 'end';
    $('payoutPct').value = 4;
    $('payoutPctNum').value = 4;
    $('yearly').querySelector('tbody').innerHTML = '';
    ['final','totalContrib','payoutAnnual'].forEach(id=> $(id).textContent = '$0');
    $('finalDesc').textContent = '';
    $('growthPortion').textContent = '';
    $('payoutBreakdown').innerHTML = 'Monthly: $0 · Quarterly: $0';
    history.replaceState(null,'',location.pathname);
    calculate();
  }

  // Events
  $('calc').addEventListener('click', calculate);
  $('csv').addEventListener('click', exportCSV);
  $('share').addEventListener('click', copyShareLink);
  $('reset').addEventListener('click', reset);
  $('toggleTheme').addEventListener('click', toggleTheme);

  // Sync payout range & number
  function syncPayout(e){
    if(e.target.id === 'payoutPct'){ $('payoutPctNum').value = e.target.value; }
    if(e.target.id === 'payoutPctNum'){ $('payoutPct').value = e.target.value; }
    calculate();
  }
  $('payoutPct').addEventListener('input', syncPayout);
  $('payoutPctNum').addEventListener('input', syncPayout);

  // Auto-calc as you type (debounced)
  const debouncedCalc = debounce(calculate, 160);
  ['initial','monthly','rate','years','freq','contribTiming'].forEach(id=>{
    $(id).addEventListener('input', debouncedCalc);
    $(id).addEventListener('change', debouncedCalc);
  });

  // Load from URL if present, else defaults
  applyState(readQuery());
  calculate();

  // Show install tip once if not installed
  const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if (isIOS && !isStandalone && !localStorage.getItem('a2hs_tip_shown')) {
    setTimeout(()=>{ try { alert('Tip: Tap the Share button → “Add to Home Screen” to install.'); } catch(e){} }, 600);
    localStorage.setItem('a2hs_tip_shown','1');
  }
})();
</script>

<!-- Register the service worker for offline support (GitHub Pages subpath safe) -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(console.error);
  }
</script>
</body>
</html>
